# crypto_admin2 開発計画（Next.js + Supabase）

最終更新: 2026-02-18

## 1. 目的

`../crypto_admin`（Laravel版）の主要機能を、`crypto_admin2` で **Next.js 15 + Supabase** 構成に置き換える。

- 個人向け暗号資産ポートフォリオ管理を継続運用できること
- WAC（加重平均取得単価）ベースの損益計算を正しく再現すること
- 既存 Supabase マイグレーションと Edge Functions を活用し、フロントを段階的に移行すること

---

## 2. スコープ

### 2.1 対象（In Scope）
1. 認証（ログイン/新規登録/パスワードリセット）
2. ポートフォリオダッシュボード（残高・評価損益）
3. 取引管理（入金/売却/スワップ/振替/エアドロップ）
4. アカウント管理
5. カテゴリ管理
6. 損益レポート（確定/評価）
7. 残高履歴

### 2.2 対象外（Out of Scope）
- テクニカル分析（MACD/RSI/BB）
- 取引所API連携（Bybit/Bitget等）
- Zaim/Notion連携
- 価格アラート/プッシュ通知
- オートリバランス

---

## 3. 開発方針

1. **DBファースト**: `supabase/migrations` を正として実装
2. **計算ロジックの単一化**: WAC・損益計算は共通層に集約
3. **RLS前提設計**: すべてのCRUDをユーザー境界で安全に実装
4. **段階リリース**: フェーズ単位で動くものを先に出す
5. **テスト先行の要所実装**: 会計ロジックは必ずテストで担保

---

## 4. フェーズ計画（目安 8週間）

## Phase 1（Week 1）基盤構築

### 目的
Next.js 開発基盤を整え、今後の実装速度と品質を確保する。

### 実施項目
- Next.js 15 (App Router) + TypeScript 初期化
- Tailwind CSS + shadcn/ui セットアップ
- Supabase client/server 設定
- next-intl（ja/en）設定
- TanStack Query + Zustand 設定
- Vitest + RTL 設定
- CI最小構成（lint/typecheck/test）

### 完了条件
- `pnpm dev` で起動
- `pnpm lint && pnpm typecheck && pnpm test` が通る

---

## Phase 2（Week 2）認証・アプリ骨格

### 目的
認証導線とダッシュボードのルーティングを成立させる。

### 実施項目
- ログイン/新規登録/パスワードリセット画面
- 認証ミドルウェア（未ログイン時リダイレクト）
- 共通レイアウト（サイドバー/ヘッダー）
- 多言語切替 UI

### 完了条件
- 認証後に `/[locale]/portfolio` へ遷移
- 認証なしで保護ルートにアクセスできない

---

## Phase 3（Week 3-4）コアCRUD（取引/管理）

### 目的
日常運用に必要なデータ入力・編集機能を実装する。

### 実施項目
- アカウント管理（一覧/作成/編集/削除）
- カテゴリ管理（一覧/作成/編集/削除）
- 取引一覧（フィルタ/ソート/ページング）
- 入金フォーム（purchases type=d）
- 売却フォーム（sells type=s, 利益計算連携）
- スワップフォーム（purchases+sells+swaps の整合登録）
- 振替フォーム（transfers）
- エアドロップフォーム（purchases type=a）

### 完了条件
- 各取引のCRUDがUIから操作可能
- 不正入力（負数/必須漏れ）がZodで弾かれる
- RLS違反時のハンドリング実装

---

## Phase 4（Week 5）ポートフォリオ表示

### 目的
資産状況を把握できる最小のダッシュボードを完成させる。

### 実施項目
- 残高サマリー（総評価額/確定損益/評価損益）
- アカウント別集計
- カテゴリ別集計
- 主要指標カードと一覧

### 完了条件
- 主要数値が表示され、取引更新後に再取得反映される

---

## Phase 5（Week 6）分析・履歴

### 目的
運用判断に必要な分析画面を提供する。

### 実施項目
- 損益レポート（月次/年次）
- 残高履歴グラフ（日次）
- 集計API（必要時）またはSupabase query最適化

### 完了条件
- 期間指定で損益推移を確認できる
- 日次履歴グラフが描画される

---

## Phase 6（Week 7）品質強化

### 目的
会計ロジックと画面品質の担保。

### 実施項目
- WAC計算テスト（正常/境界/異常）
- 取引作成→集計反映の統合テスト
- 主要画面のUIテスト
- エラーハンドリング統一
- パフォーマンス改善（N+1/再レンダリング対策）

### 完了条件
- 主要テストがCIで安定通過
- 重大バグゼロでUAT投入可能

---

## Phase 7（Week 8）UAT・リリース準備

### 目的
本番運用開始に必要な確認と手順を確定する。

### 実施項目
- UAT（既存運用データで確認）
- リリース手順書・ロールバック手順作成
- 監視項目整理（エラー率/レスポンス/Edge Function失敗）
- 初期運用タスク整理

### 完了条件
- UAT承認
- 本番反映Go判断可能

---

## 5. 重要リスクと対策

1. **WAC再計算漏れ**
   - 対策: 編集/削除時の再計算フローをユースケース化しテスト固定
2. **スワップ整合性崩れ**
   - 対策: DBトランザクション + `swaps` テーブル制約を活用
3. **RLSによる想定外エラー**
   - 対策: 主要クエリの権限テストを先行
4. **旧システムとの差分**
   - 対策: 比較用データで残高・損益差分を定期確認

---

## 6. 受け入れ基準（全体）

- 認証後に主要業務フロー（取引登録→集計→確認）が完結する
- 主要トランザクションの損益計算結果が期待値と一致する
- 日本語/英語の最低限UIが機能する
- 本番運用手順と障害時手順が文書化されている
